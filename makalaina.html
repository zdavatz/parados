<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MAKA LAINA - The Strategic Endspurt</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #game-container { display: flex; gap: 30px; }
        #board { 
            display: grid; grid-template-columns: repeat(12, 42px); 
            grid-template-rows: repeat(12, 42px); gap: 1px; 
            background: #2c3e50; border: 5px solid #2c3e50; border-radius: 4px;
        }
        .cell { width: 42px; height: 42px; background: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .cell.los { background: #fffde7; } 
        .cell.selected { background: #e3f2fd; border: 2px solid #2196f3; box-sizing: border-box; }
        .disc { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-shadow: 1px 1px 2px #000; z-index: 2; border: 1px solid rgba(0,0,0,0.1); }
        .collector { width: 36px; height: 36px; border: 3px solid gold; border-radius: 6px; z-index: 3; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .black { background: #000; }
        .white { background: #fff; border-color: #000; }
        
        #ui { width: 380px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-rules { background: #3498db; color: white; }
        .btn-action { background: #9b59b6; color: white; }
        .btn-reset { background: #e74c3c; color: white; margin-top: 20px; }
        
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        #modal { background: white; width: 80%; max-width: 600px; padding: 30px; border-radius: 12px; max-height: 80vh; overflow-y: auto; }
        .scoring-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85em; }
        .scoring-table td, .scoring-table th { border: 1px solid #eee; padding: 6px; text-align: center; }
        .worthless { text-decoration: line-through; color: #bdc3c7; }
    </style>
</head>
<body>

    <h1>MAKA LAINA</h1>
    <div id="game-container">
        <div id="board"></div>
        <div id="ui">
            <div id="status" style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">SETUP: Player 1, place both collectors.</div>
            <button class="btn btn-rules" onclick="toggleRules(true)">View Rules</button>
            <hr>
            <div id="game-actions" style="display:none;">
                <button class="btn btn-action" onclick="relinquishTurn()">Relinquish Turn</button>
                <p style="font-size: 0.75em; color: #7f8c8d; text-align: center;">If stuck, sacrifice a collected disc to move your collector[cite: 35].</p>
            </div>
            <table class="scoring-table">
                <thead><tr><th>Color</th><th>P1</th><th>P2</th></tr></thead>
                <tbody id="score-body"></tbody>
            </table>
            <button class="btn btn-reset" onclick="window.location.reload()">Reset Game</button>
        </div>
    </div>

    <div id="modal-overlay" onclick="toggleRules(false)">
        <div id="modal" onclick="event.stopPropagation()">
            <div class="rules-text">
                <h2>The Endspurt Rule</h2>
                <p>The game ends when all discs are collected, or both players relinquish their moves[cite: 43]. <b>Crucially</b>, to keep the tension, the game ends before the very last possible connection can be made.</p>
                <h3>Shifting & Collection</h3>
                <ul>
                    <li>Shift a disc 1 square into your Line of Sight (LOS)[cite: 18].</li>
                    <li>The disc <b>cannot</b> have been in your LOS at start of turn[cite: 19].</li>
                    <li>LOS is blocked by other discs or collectors[cite: 20].</li>
                </ul>
                <h3>Special Mechanics</h3>
                <ul>
                    <li><b>Number 1:</b> Immediate extra turn[cite: 31].</li>
                    <li><b>Number 6:</b> Future discs of that color are worthless[cite: 32].</li>
                    <li><b>Stuck?:</b> Sacrifice a collected primary disc to move your collector up to that disc's value.</li>
                </ul>
            </div>
        </div>
    </div>

<script>
    let gameState = 'PLACEMENT';
    let currentPlayer = 1; 
    let collectors = { 1: null, 2: null };
    let selectedIdx = null;
    let cells = Array(144).fill(null);
    let bag = [];
    let playerFlags = { 1: {}, 2: {} };
    let scores = { 1: {}, 2: {} };
    let relinquished = { 1: false, 2: false };
    const colors = ['red', 'blue', 'yellow', 'green', 'orange', 'purple'];

    function toggleRules(show) { document.getElementById('modal-overlay').style.display = show ? 'flex' : 'none'; }

    function initBag() {
        ['red', 'blue', 'yellow'].forEach(c => [1,2,2,3,3,3,4,4,4,5,5,6].forEach(n => bag.push({color:c, num:n, type:'primary'})));
        ['green', 'orange', 'purple'].forEach(c => { for(let i=0; i<6; i++) bag.push({color:c, num:'', type:'secondary'}); });
        bag.sort(() => Math.random() - 0.5);
        bag.splice(0, 6); 
        colors.forEach(c => { scores[1][c] = 0; scores[2][c] = 0; });
    }

    function createBoard() {
        const boardDiv = document.getElementById('board');
        for (let i = 0; i < 144; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${i}`;
            cell.onclick = () => handleClick(i);
            boardDiv.appendChild(cell);
        }
    }

    function handleClick(i) {
        if (gameState === 'PLACEMENT') {
            if (cells[i]) return;
            if (!collectors[1]) { collectors[1] = i; cells[i] = {type:'collector', player:1}; }
            else if (!collectors[2]) { collectors[2] = i; cells[i] = {type:'collector', player:2}; startPlay(); }
            render();
        } else if (gameState === 'PLAY') {
            handleMove(i);
        }
    }

    function startPlay() {
        gameState = 'PLAY';
        document.getElementById('game-actions').style.display = 'block';
        for (let i = 0; i < 24; i++) {
            let r; do { r = Math.floor(Math.random() * 144); } while (cells[r]);
            cells[r] = bag.pop();
        }
        updateUI(); render();
    }

    function getLOS(idx) {
        const los = [];
        const r = Math.floor(idx / 12), c = idx % 12;
        [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr, dc]) => {
            for (let d = 1; d < 12; d++) {
                let nr = r + dr*d, nc = c + dc*d;
                if (nr < 0 || nr >= 12 || nc < 0 || nc >= 12) break;
                let id = nr * 12 + nc;
                los.push(id);
                if (cells[id]) break; 
            }
        });
        return los;
    }

    function handleMove(i) {
        const los = getLOS(collectors[currentPlayer]);
        if (selectedIdx === null) {
            if (cells[i] && cells[i].type !== 'collector' && !los.includes(i)) {
                selectedIdx = i; render();
            }
        } else {
            const dist = Math.max(Math.abs(Math.floor(i/12)-Math.floor(selectedIdx/12)), Math.abs((i%12)-(selectedIdx%12)));
            if (!cells[i] && dist === 1 && getLOS(collectors[currentPlayer]).includes(i)) {
                processCollection(cells[selectedIdx], i);
            } else {
                selectedIdx = null; render();
            }
        }
    }

    function processCollection(disc, newIdx) {
        const colorKey = disc.color + '6';
        if (!playerFlags[currentPlayer][colorKey]) {
            scores[currentPlayer][disc.color] += (disc.num || 1);
            if (disc.num === 6) playerFlags[currentPlayer][colorKey] = true;
        }
        cells[collectors[currentPlayer]] = null;
        cells[selectedIdx] = null;
        collectors[currentPlayer] = newIdx;
        cells[newIdx] = { type: 'collector', player: currentPlayer };
        selectedIdx = null;
        relinquished[1] = relinquished[2] = false;
        
        // Endgame Check: Count remaining discs
        const remaining = cells.filter(c => c && c.type !== 'collector').length;
        if (remaining <= 1) { // End before the very last connection
            gameState = 'END';
            alert("Game Over! The final sprint is complete.");
        } else if (disc.num !== 1) {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
        }
        updateUI(); render();
    }

    function relinquishTurn() {
        relinquished[currentPlayer] = true;
        if (relinquished[1] && relinquished[2]) {
            gameState = 'END';
            alert("Both players relinquished. Game Over.");
        } else {
            currentPlayer = currentPlayer === 1 ? 2 : 1;
        }
        updateUI();
    }

    function updateUI() {
        const status = document.getElementById('status');
        if (gameState === 'END') status.innerText = "GAME OVER";
        else if (gameState === 'PLAY') status.innerText = `Turn: Player ${currentPlayer}`;
        
        const body = document.getElementById('score-body');
        body.innerHTML = '';
        colors.forEach(c => {
            const p1W = playerFlags[1][c+'6'] ? 'worthless' : '';
            const p2W = playerFlags[2][c+'6'] ? 'worthless' : '';
            body.innerHTML += `<tr><td>${c.toUpperCase()}</td><td class="${p1W}">${scores[1][c]}</td><td class="${p2W}">${scores[2][c]}</td></tr>`;
        });
    }

    function render() {
        const los = (gameState === 'PLAY') ? getLOS(collectors[currentPlayer]) : [];
        for (let i = 0; i < 144; i++) {
            const el = document.getElementById(`cell-${i}`);
            el.innerHTML = '';
            el.className = 'cell' + (los.includes(i) ? ' los' : '') + (selectedIdx === i ? ' selected' : '');
            if (cells[i]) {
                const d = document.createElement('div');
                if (cells[i].type === 'collector') d.className = `collector ${cells[i].player === 1 ? 'black' : 'white'}`;
                else {
                    d.className = 'disc'; d.style.backgroundColor = cells[i].color;
                    d.innerText = cells[i].num;
                }
                el.appendChild(d);
            }
        }
    }

    initBag(); createBoard();
</script>
</body>
</html>
